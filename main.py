import xml.etree.ElementTree as ET 
import csv
import os
import boto3
import tempfile
import numpy as np

def parseIssueItems(tree):
    issue_list = []

    #loop through all the issue items
    for issueItem in tree.iter('{http://glasswall.com/namespace}IssueItem'):

        #get the issue count for the issue item
        count = int(issueItem[2].text)

        #add to issue_list according to the issue count
        for x in range(count):
            issue_list.append(int(issueItem[1].text))
    
    return issue_list

def parseSanitisationItems(tree):
    sanitisation_list = []

    dde_cnt = 0
    embededfiles_cnt = 0
    embeddedimages_cnt = 0
    externalhyperlinks_cnt = 0
    internalhyperlinks_cnt = 0
    macros_cnt = 0
    metadata_cnt = 0
    reviewcomments_cnt = 0
    acroforms_cnt = 0
    actions_cnt = 0
    javascript_cnt = 0

    #loop through all the issue items
    for sanitisationItem in tree.iter('{http://glasswall.com/namespace}SanitisationItem'):

        #get the issue count for the issue item
        count = int(sanitisationItem[2].text)

        if "javascript" in sanitisationItem[0].text.lower():
            javascript_cnt = javascript_cnt + count
        elif "macro" in sanitisationItem[0].text.lower():
            macros_cnt = macros_cnt + count
        elif "metadata" in sanitisationItem[0].text.lower():
            metadata_cnt = metadata_cnt + count
        elif "review" in sanitisationItem[0].text.lower():
            reviewcomments_cnt = reviewcomments_cnt + count
        elif "image" in sanitisationItem[0].text.lower():
            embeddedimages_cnt = embeddedimages_cnt + count
        elif "embedded" in sanitisationItem[0].text.lower():
            embededfiles_cnt = embededfiles_cnt + count
        elif "acroform" in sanitisationItem[0].text.lower():
            acroforms_cnt = acroforms_cnt + count
        elif "action" in sanitisationItem[0].text.lower():
            actions_cnt = actions_cnt + count
        elif "external" in sanitisationItem[0].text.lower():
            externalhyperlinks_cnt = externalhyperlinks_cnt + count
        elif "internal" in sanitisationItem[0].text.lower():
            internalhyperlinks_cnt = internalhyperlinks_cnt + count       
        elif "dynamic" in sanitisationItem[0].text.lower():
            dde_cnt = dde_cnt + count                                                                                               

    sanitisation_list = [str(dde_cnt), str(embededfiles_cnt), str(embeddedimages_cnt), str(externalhyperlinks_cnt), str(internalhyperlinks_cnt), str(macros_cnt), str(metadata_cnt), str(reviewcomments_cnt), str(acroforms_cnt), str(acroforms_cnt), str(javascript_cnt)]
   
    return sanitisation_list

def parseRemediationItems(tree):
    remediationCount = 0

    #loop through all the remedy items
    for remediationItem in tree.iter('{http://glasswall.com/namespace}RemedyItem'):

        #get the remedy count for the remedy item
        count = int(remediationItem[1].text)

        remediationCount = remediationCount + count
    
    return remediationCount

def generateIssueRanges(issue_list):
    #place issue ids found into their ranges
    issue_bins_input=[96, 16842802, 16973824, 17236018, 17301554, 17367090, 17432626, 17498162, 17563698, 17629234, 17694770, 17760306, 17825842, 17891378, 17956914, 18022450, 18087986, 18153522, 18219058, 18284594, 18350130, 18415666, 18481202, 18546738, 18612274, 18677810, 18743346, 18808882, 18874418, 18939954, 19005490, 19071026, 19136562, 19202098, 19267634, 19333170, 19398706, 19464242, 19529778, 19595314, 19660850, 19726386, 19791922, 19857458, 19922994, 19988530, 30146560, 30212096, 30277632, 30343168, 30539776, 30670848, 30801920, 30867456, 30932992, 30998528, 33751040, 33882162, 33947698, 34013234, 34078770, 34144306, 34209842, 34275378, 34340914, 34406450, 34471986, 34537522, 34603058, 34668594, 34734130, 34799666, 34865202, 34930738, 34996274, 35061810, 35127346, 35192882, 35258418, 35323954, 35389490, 46923776, 46989312, 47054848, 47120384, 47316992, 47448064, 47579136, 47644672, 47710208, 47775744, 50528256, 50724914, 50855986, 50921522, 50987058, 51052594, 51118130, 51183666, 51249202, 51314738, 51380274, 51445810, 51511346, 51576882, 51642418, 51707954, 51773490, 51839026, 51904562, 51970098, 52035634, 52101170, 52166706, 52363314, 63700992, 63766528, 63832064, 63897600, 64094208, 64225280, 64356352, 64421888, 64552960, 83951616, 84017152, 84279296, 84344832, 84410368, 84475904, 84541440, 84606976, 84672512, 84738048, 84803584, 84869120, 84934656, 85000192, 85131264, 85196800, 85262336, 85327872, 85590016, 85655552, 85721088, 85786624, 85852160, 85917696, 85983232, 86048768, 86114304, 86179840, 86245376, 86310912, 86376448, 86441984, 86507520, 86573056, 86638592, 86704128, 86769664, 86835200, 86900736, 86966272, 87031808, 87097344, 87162880, 87228416, 87359488, 87425024, 87490560, 87556096, 87687168, 87752704, 87818240, 87949312, 88014848, 88145920, 88211456, 88276992, 88342528, 88408064, 88473600, 88539136, 88604672, 88670208, 88735744, 88801280, 97255424, 97320960, 97386496, 97452032, 97648640, 97779712, 97910784, 97976320, 98041856, 98107392, 100728832, 100859904, 100925440, 100990976, 101056512, 101122048, 101187584, 101253120, 101318656, 101384192, 101449728, 101515264, 101580800, 101646336, 101711872, 117702656, 117768192, 117833728, 117899264, 117964800, 118030336, 118095872, 118161408, 118226944, 134283264, 134348800, 134414336, 134479872, 134545408, 134610944, 134676480, 134742016, 134807552, 134873088, 134938624, 135004160, 135069696, 135135232, 135200768, 135266304, 135331840, 135397376, 135462912, 135528448, 135593984, 135659520, 135725056, 135790592, 135856128, 135921664, 135987200, 136052736, 136118272, 151060480, 151126016, 151191552, 151257088, 151322624, 151388160, 167837696, 167903232, 167968768, 168034304, 168099840, 168165376, 168230912, 168296448, 168361984, 168427520, 168493056, 168558592, 168624128, 168689664, 184614912, 184680448, 184745984, 184811520, 184877056, 184942592, 185008128, 185073664, 185139200, 185204736, 185270272, 185335808, 185401344, 185466880, 185532416, 185597952, 185663488, 185729024, 185794560, 185860096, 185991168, 186056704, 186122240, 186187776, 186253312, 186318848, 186384384, 186449920, 186515456, 186580992, 186646528, 186712064, 186777600, 186843136, 186908672, 186974208, 187039744, 187105280, 187170816, 187236352, 187301888, 187367424, 187432960, 187498496, 187564032, 187695104, 187760640, 187826176, 187891712, 187957248, 188022784, 188088320, 188153856, 188219392, 188284928, 188350464, 188416000, 188481536, 188612608, 188678144, 188743680, 188809216, 188874752, 197984256, 198049792, 198115328, 198180864, 198246400, 198311936, 198377472, 198443008, 198508544, 198639616, 198770688, 201392128, 201457664, 201523200, 201588736, 201654272, 218169344, 234946560, 235012096, 235077632, 235143168, 235208704, 235274240, 235339776, 235405312, 251789312, 251854848, 251920384, 268500992, 268566528, 268632064, 268697600, 268763136, 268828672, 285278208, 285343744, 285409280, 285474816, 285540352, 285605888, 285671424, 285736960, 285802496, 318832640, 335609856, 335675391]
    issue_hist, issue_bins = np.histogram(issue_list, bins=issue_bins_input)

    issueRanges = []

    for issueRange in issue_hist:
        issueRanges.append(str(issueRange))

    return issueRanges

def parseAnalysisReport(tree, writer, file_id):
    #get file type from the xml
    print("processing file : " + str(file_id))

    for child in tree.iter('{http://glasswall.com/namespace}DocumentSummary'):
        fileType = child[1].text

    issue_list = parseIssueItems(tree)
    sanitisation_list = parseSanitisationItems(tree)
    remediationCount = parseRemediationItems(tree)
    
    if len(issue_list) == 0 and all(i == "0" for i in sanitisation_list) and remediationCount == 0:
        print("No issues, sanitisations or remediations found in file: " + str(file_id))
        return

    issueRanges = generateIssueRanges(issue_list)

    row = []
    row.extend([file_id, fileType, "1"])
    row.extend(issueRanges)
    row.extend(sanitisation_list)
    row.extend([remediationCount])

    writer.writerow(row)

def main():
    #create new CSV file for ouput
    csvFile = open('test.csv', 'w', newline='', encoding='utf-8')
    csvWriter = csv.writer(csvFile)

    #add in column names
    col_names = ['fileId', 'fileType', 'malicious', '96-96', '16842802-16908287', '16973824-17039359', '17236018-17301503', '17301554-17367039', '17367090-17432575', '17432626-17498111', '17498162-17563647', '17563698-17629183', '17629234-17694719', '17694770-17760255', '17760306-17825791', '17825842-17891327', '17891378-17956863', '17956914-18022399', '18022450-18087935', '18087986-18153471', '18153522-18219007', '18219058-18284543', '18284594-18350079', '18350130-18415615', '18415666-18481151', '18481202-18546687', '18546738-18612223', '18612274-18677759', '18677810-18743295', '18743346-18808831', '18808882-18874367', '18874418-18939903', '18939954-19005439', '19005490-19070975', '19071026-19136511', '19136562-19202047', '19202098-19267583', '19267634-19333119', '19333170-19398655', '19398706-19464191', '19464242-19529727', '19529778-19595263', '19595314-19660799', '19660850-19726335', '19726386-19791871', '19791922-19857407', '19857458-19922943', '19922994-19988479', '19988530-20054015', '30146560-30212095', '30212096-30277631', '30277632-30343167', '30343168-30408703', '30539776-30605311', '30670848-30736383', '30801920-30867455', '30867456-30932991', '30932992-30998527', '30998528-31064063', '33751040-33816575', '33882162-33947647', '33947698-34013183', '34013234-34078719', '34078770-34144255', '34144306-34209791', '34209842-34275327', '34275378-34340863', '34340914-34406399', '34406450-34471935', '34471986-34537471', '34537522-34603007', '34603058-34668543', '34668594-34734079', '34734130-34799615', '34799666-34865151', '34865202-34930687', '34930738-34996223', '34996274-35061759', '35061810-35127295', '35127346-35192831', '35192882-35258367', '35258418-35323903', '35323954-35389439', '35389490-35454975', '46923776-46989311', '46989312-47054847', '47054848-47120383', '47120384-47185919', '47316992-47382527', '47448064-47513599', '47579136-47644671', '47644672-47710207', '47710208-47775743', '47775744-47841279', '50528256-50593791', '50724914-50790399', '50855986-50921471', '50921522-50987007', '50987058-51052543', '51052594-51118079', '51118130-51183615', '51183666-51249151', '51249202-51314687', '51314738-51380223', '51380274-51445759', '51445810-51511295', '51511346-51576831', '51576882-51642367', '51642418-51707903', '51707954-51773439', '51773490-51838975', '51839026-51904511', '51904562-51970047', '51970098-52035583', '52035634-52101119', '52101170-52166655', '52166706-52232191', '52363314-52428799', '63700992-63766527', '63766528-63832063', '63832064-63897599', '63897600-63963135', '64094208-64159743', '64225280-64290815', '64356352-64421887', '64421888-64487423', '64552960-64618495', '83951616-84017151', '84017152-84082687', '84279296-84344831', '84344832-84410367', '84410368-84475903', '84475904-84541439', '84541440-84606975', '84606976-84672511', '84672512-84738047', '84738048-84803583', '84803584-84869119', '84869120-84934655', '84934656-85000191', '85000192-85065727', '85131264-85196799', '85196800-85262335', '85262336-85327871', '85327872-85393407', '85590016-85655551', '85655552-85721087', '85721088-85786623', '85786624-85852159', '85852160-85917695', '85917696-85983231', '85983232-86048767', '86048768-86114303', '86114304-86179839', '86179840-86245375', '86245376-86310911', '86310912-86376447', '86376448-86441983', '86441984-86507519', '86507520-86573055', '86573056-86638591', '86638592-86704127', '86704128-86769663', '86769664-86835199', '86835200-86900735', '86900736-86966271', '86966272-87031807', '87031808-87097343', '87097344-87162879', '87162880-87228415', '87228416-87293951', '87359488-87425023', '87425024-87490559', '87490560-87556095', '87556096-87621631', '87687168-87752703', '87752704-87818239', '87818240-87883775', '87949312-88014847', '88014848-88080383', '88145920-88211455', '88211456-88276991', '88276992-88342527', '88342528-88408063', '88408064-88473599', '88473600-88539135', '88539136-88604671', '88604672-88670207', '88670208-88735743', '88735744-88801279', '88801280-88866815', '97255424-97320959', '97320960-97386495', '97386496-97452031', '97452032-97517567', '97648640-97714175', '97779712-97845247', '97910784-97976319', '97976320-98041855', '98041856-98107391', '98107392-98172927', '100728832-100794367', '100859904-100925439', '100925440-100990975', '100990976-101056511', '101056512-101122047', '101122048-101187583', '101187584-101253119', '101253120-101318655', '101318656-101384191', '101384192-101449727', '101449728-101515263', '101515264-101580799', '101580800-101646335', '101646336-101711871', '101711872-101777407', '117702656-117768191', '117768192-117833727', '117833728-117899263', '117899264-117964799', '117964800-118030335', '118030336-118095871', '118095872-118161407', '118161408-118226943', '118226944-118292479', '134283264-134348799', '134348800-134414335', '134414336-134479871', '134479872-134545407', '134545408-134610943', '134610944-134676479', '134676480-134742015', '134742016-134807551', '134807552-134873087', '134873088-134938623', '134938624-135004159', '135004160-135069695', '135069696-135135231', '135135232-135200767', '135200768-135266303', '135266304-135331839', '135331840-135397375', '135397376-135462911', '135462912-135528447', '135528448-135593983', '135593984-135659519', '135659520-135725055', '135725056-135790591', '135790592-135856127', '135856128-135921663', '135921664-135987199', '135987200-136052735', '136052736-136118271', '136118272-136183807', '151060480-151126015', '151126016-151191551', '151191552-151257087', '151257088-151322623', '151322624-151388159', '151388160-151453695', '167837696-167903231', '167903232-167968767', '167968768-168034303', '168034304-168099839', '168099840-168165375', '168165376-168230911', '168230912-168296447', '168296448-168361983', '168361984-168427519', '168427520-168493055', '168493056-168558591', '168558592-168624127', '168624128-168689663', '168689664-168755199', '184614912-184680447', '184680448-184745983', '184745984-184811519', '184811520-184877055', '184877056-184942591', '184942592-185008127', '185008128-185073663', '185073664-185139199', '185139200-185204735', '185204736-185270271', '185270272-185335807', '185335808-185401343', '185401344-185466879', '185466880-185532415', '185532416-185597951', '185597952-185663487', '185663488-185729023', '185729024-185794559', '185794560-185860095', '185860096-185925631', '185991168-186056703', '186056704-186122239', '186122240-186187775', '186187776-186253311', '186253312-186318847', '186318848-186384383', '186384384-186449919', '186449920-186515455', '186515456-186580991', '186580992-186646527', '186646528-186712063', '186712064-186777599', '186777600-186843135', '186843136-186908671', '186908672-186974207', '186974208-187039743', '187039744-187105279', '187105280-187170815', '187170816-187236351', '187236352-187301887', '187301888-187367423', '187367424-187432959', '187432960-187498495', '187498496-187564031', '187564032-187629567', '187695104-187760639', '187760640-187826175', '187826176-187891711', '187891712-187957247', '187957248-188022783', '188022784-188088319', '188088320-188153855', '188153856-188219391', '188219392-188284927', '188284928-188350463', '188350464-188415999', '188416000-188481535', '188481536-188547071', '188612608-188678143', '188678144-188743679', '188743680-188809215', '188809216-188874751', '188874752-188940287', '197984256-198049791', '198049792-198115327', '198115328-198180863', '198180864-198246399', '198246400-198311935', '198311936-198377471', '198377472-198443007', '198443008-198508543', '198508544-198574079', '198639616-198705151', '198770688-198836223', '201392128-201457663', '201457664-201523199', '201523200-201588735', '201588736-201654271', '201654272-201719807', '218169344-218234879', '234946560-235012095', '235012096-235077631', '235077632-235143167', '235143168-235208703', '235208704-235274239', '235274240-235339775', '235339776-235405311', '235405312-235470847', '251789312-251854847', '251854848-251920383', '251920384-251985919', '268500992-268566527', '268566528-268632063', '268632064-268697599', '268697600-268763135', '268763136-268828671', '268828672-268894207', '285278208-285343743', '285343744-285409279', '285409280-285474815', '285474816-285540351', '285540352-285605887', '285605888-285671423', '285671424-285736959', '285736960-285802495', '285802496-285868031', '318832640-318898175', '335609856-335675391', 'Dynamic Data Exchange', 'Embedded Files', 'Embedded Images', 'External Hyperlinks', 'Internal Hyperlinks', 'Macros', 'Metadata', 'Review Comments', 'Acroform', 'Actions All', 'Javascript', 'Remediation Count']
    csvWriter.writerow(col_names)

    #get s3 resource
    s3Resource = boto3.resource('s3')
    s3Client = boto3.client('s3')
    bucket = s3Resource.Bucket('malicious-file-analysis-reports')

    file_id = 0

    #loop through objects in the bucket
    
    for obj in bucket.objects.all():

        with tempfile.TemporaryFile() as f:
            file_id = file_id + 1

            s3Client.download_fileobj(obj._bucket_name, obj.key, f)
            f.seek(0)
        
            tree = ET.fromstring(f.read())
            parseAnalysisReport(tree, csvWriter, file_id)

    csvFile.close()

if __name__ == "__main__":
    main()